<!DOCTYPE HTML>
<html>

<body>

  <p> (Enter) - mitte responsum <br>
  (â†’) - iam scio et certus sum! nolite me iterum rogare!</p>
  
  
  <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
  <script>
	var all_verbs;
	var mutation_dict;
	var current_mutation;
	var selected_verbs = ["amo", "habeo", "capio", "audio", "aderro"];
	var selected_inflections = ["indicative active perfect 1st singular", "perfect passive participle"]
    var all_verbs_loader = $.getJSON({'url': "https://raw.githubusercontent.com/danelh/danelh.github.io/master/verbs_new.json", 'async': true});
	all_verbs_loader.done(function(){
		all_verbs = all_verbs_loader.responseJSON
		console.log("finish loading verbs");
		init();}
	);
  </script>
  
  <p id="demo" onclick="init()">Not support multiple answers like: amo perfect several tenses.</p>
	
  <p id="question" onclick="start_q()">Click me to new q.</p>
  
  <input type="text" id="user_answer">
  
  <p id="res" ></p>
  
  <script>
  function init() {		
	console.log(all_verbs);
	var inflected = all_verbs["amo"][selected_inflections[0]];
    document.getElementById("demo").innerHTML = inflected;
	mutation_dict = get_valid_mutations_dict();
	
	var user_answer_input = document.getElementById("user_answer");	
	user_answer_input.addEventListener("keydown", function(event) {
	var x = event.which || event.keyCode;
	if (x === 13) {		
		conclude_q();
	}
	else if (x === 39){		
		remove_mutation();
	}
	else{		
		document.getElementById("res").innerHTML = "";
	}
	});	
  }
  
  function start_q(){
	document.getElementById("user_answer").value = "";	
	console.log(mutation_dict);
	current_mutation = select_mutation()
    document.getElementById("question").innerHTML = current_mutation;	
  }
  
  function conclude_q(){			
	if (is_user_correct()){
		color = "green";
		mutation_dict[current_mutation] /= 2;
	}
	else{
		color = "red";
		mutation_dict[current_mutation] = 1;
	}
	document.getElementById("res").style.color = color;
	document.getElementById("res").innerHTML = get_correct_answer_for_current_mutation();
	
	start_q();
  }
  
  function remove_mutation(){
	delete mutation_dict[current_mutation];
	if (is_obj_empty(mutation_dict)){
		document.getElementById("res").style.color = "green";
		document.getElementById("res").innerHTML = "Mirabile! scis omnia. Elige alia verba/infleciones";
	}
	else{
		document.getElementById("res").style.color = "gray";
		document.getElementById("res").innerHTML = "Bene, iam scis hoc...sed allia?";
		start_q();
	}
  }
  
  function is_user_correct(){	
	user_answer = document.getElementById("user_answer").value;
	correct_answer = get_correct_answer_for_current_mutation();
	return (user_answer == correct_answer);
  }
  
  function get_correct_answer_for_current_mutation(){
	console.log(current_mutation);
	dict_res = all_verbs[current_mutation[0]][current_mutation[1]];
	if (dict_res){
		return dict_res.split(",")[0].trim();
	}
    return dict_res;
  }

  
  </script>
  
  <script>
  function select_mutation(){
	 return select_weighted_random(mutation_dict).split(",");
  }
  
  function is_mutation_valid(verb, inflection){
	dict_value = all_verbs[verb][inflection];
	return (dict_value != null) && (dict_value != "--");
  }
  
  function get_valid_mutations_dict(){
	var mutation_dict = {};
	var bad_mutations = []	
	for (i = 0, v_len = selected_verbs.length; i < v_len; i++) {
		for (j = 0, i_len = selected_inflections.length; j < i_len; j++) {
			if (is_mutation_valid(selected_verbs[i], selected_inflections[j])){				
				mutation_dict[[selected_verbs[i], selected_inflections[j]]] = 1;
			}
			else{
				bad_mutations.push([selected_verbs[i], selected_inflections[j]])				
			}
		}
	}	
	for (i = 0, b_len = bad_mutations.length; i < b_len; i++) {
		console.log("bad mutation: " + bad_mutations[i]);
	}
	return mutation_dict;
  }
  
  function select_weighted_random(prob){  
	var i=0;
	var sum=0;
	var w_sum = 0;
	for (x in prob){
		w_sum += prob[x];
	}
	var r=Math.random() * w_sum;
	for (i in prob) {
		sum += prob[i];
		if (r <= sum) return i;
	 }
  }
  
  function is_obj_empty(_obj){
	for (i in _obj){
		return false;}
	return true;
  }
  
  </script>
    
  <script>
  // for wait
  //alert("I am an alert box!");
//  verbs = verbs.responseJSON;
//  console.log(verbs["a"])
  </script>

</body>

</html>
