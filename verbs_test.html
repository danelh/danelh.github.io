<!DOCTYPE HTML>
<html>
<style>
#lstBox1, #lstBox2{
  height:300px;
  width:200px;
}

.approveTermsContainer{
  display:flex;
  justify-content:center;
}

.transferBtns {
  margin-right: 30px;
  margin-left: 30px;
}

.transferBtns{
  float:left; 
  align-self:center;
}

/* The switch - the box around the slider */
.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

/* Hide default HTML checkbox */
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

/* The slider */
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #2196F3;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(26px);
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Rounded sliders */
.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}
</style> 

<body>

  <p> (Enter) - mitte responsum <br>
  (â†’) - iam scio et certus sum! noli me iterum rogare!</p> 
  
  <p>
    Choose upgrades for your transport capsule.
  </p>
  
    
  <p id="demo" onclick="init()">Not support multiple answers like: amo perfect several tenses \n verb sero has 3 options but 2 or 3rd (that are differnt in prinipal parts) but we take only one 3rd (you can't know which). may be the same conjuction like "levo", but might be different sero .</p>
  
  <div class="approveTermsContainer">
  <div class="newItems">
  <b>All inflections:</b><br/>
           <select multiple="multiple" id='lstBox1'>
			</select>
  </div>
  <div class="transferBtns">
	<input type='button' id='btnRight' value ='  >  '/>
	<br/><input type='button' id='btnLeft' value ='  <  '/>
  </div>
  <div class="approvedItems">
        <b>Selected inflections: </b><br/>
        <select multiple="multiple" id='lstBox2'>
        </select>
  </div>
  </div>
  
  <h2>Search/Filter Dropdown</h2>
  <p>Click on the button to open the dropdown menu, and use the input field to search for a specific dropdown link.</p>
  
  <div>
  <label> Practice </label>
  <label class="switch">	
	<input id="is_exam_cb" type="checkbox" onchange=get_is_on_exam()>
	<span class="slider round"></span>	
  </label>
  <label> Exam </label>
  </div>

  
  <label for="level_select">Choose a level:</label>
  <select id="level_select">
	  <option value="0.1" selected="selected">Top 10% of verbs</option>
	  <option value="0.25">Top 25% of verbs</option>
	  <option value="0.5">Top 50% of verbs</option>
	  <option value="1">All verbs</option>
  </select>
  <input id="verb_select" list="verbs_datalist">
  <datalist id="verbs_datalist">
  </datalist>
  
  <label for="w3review">Enter verbs 1st sigular (example: amo)</label>
  <textarea id="verbs_box" name="verbs_box" rows="4" cols="100" onchange=load_possible_mutations()></textarea>
  <button type="button" id="generate_random verbs" onclick=generate_random_verbs()>Generate_random_verbs</button> 
  <!--<button type="button" id="validate verbs" onclick=get_verbs_from_input()>Validate verbs</button>-->
  <button type="button" id="start_button" onclick=init_exam()>Start</button>
  <p id="question">Click me to new q.</p>
  
  <input type="text" id="user_answer">
  
  <p id="res" ></p>
  
  <label id="mutations_left" style="display: block;"></label>
  <label id="answer_counter"></label>
  
  <p id="verbs_error_p" name="verbs_error_p"></p>
  <textarea id="verbs_error_box" name="verbs_error_box" rows="4" cols="50"></textarea>
  <textarea id="inflections_error_box" name="inflections_error_box" rows="4" cols="100" readonly=true disabled=true></textarea>
  
  <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
  
  <script>
  $(document).ready(function() {
    $('#btnRight').click(function(e) {
        var selectedOpts = $('#lstBox1 option:selected');
        if (selectedOpts.length == 0) {
            //alert("Nothing to move.");
            e.preventDefault();
        }

        $('#lstBox2').append($(selectedOpts).clone());
        $(selectedOpts).remove();
        e.preventDefault();
		load_possible_mutations();
    });

    $('#btnLeft').click(function(e) {
        var selectedOpts = $('#lstBox2 option:selected');
        if (selectedOpts.length == 0) {
            //alert("Nothing to move.");
            e.preventDefault();
        }

        $('#lstBox1').append($(selectedOpts).clone());
        $(selectedOpts).remove();
        e.preventDefault();
		load_possible_mutations();
    });
  });
  </script>
  
  <script>
	var all_verbs, sorted_verbs;
	var mutation_dict;
	var current_mutation;
	var selected_verbs = [];
	var mistake_counter = 0;
	var correct_counter = 0;
	var is_exam;
	var sorted_verbs_loader = $.getJSON({'url': "https://raw.githubusercontent.com/danelh/danelh.github.io/master/verbs_sorted_by_freq.json", 'async': true});
    var all_verbs_loader = $.getJSON({'url': "https://raw.githubusercontent.com/danelh/danelh.github.io/master/verbs_new.json", 'async': true});
	all_verbs_loader.done(function(){
		all_verbs = all_verbs_loader.responseJSON
		sorted_verbs = sorted_verbs_loader.responseJSON
		console.log("finish loading verbs");
		init();}
	);	
  </script>
  
  <script>
  function init() {		
	console.log(sorted_verbs);	
	var user_answer_input = document.getElementById("user_answer");	
	user_answer_input.addEventListener("keydown", function(event) {
	var x = event.which || event.keyCode;
	if (x === 13) {		
		conclude_q();
	}
	else if (x === 39){		
		remove_mutation();
	}
	else{		
		document.getElementById("res").innerHTML = "";
	}
	});
		
	populate_inflections();
	populate_verbs_in_select();
	get_is_on_exam();
  }
  
  function populate_inflections(){
	default_inflections = ["indicative active perfect 1st singular", "perfect passive participle"]
	all_possible_inflections = get_all_possible_inflections();	
	//all_possible_inflections = all_possible_inflections.filter(function(value, index, arr){ return !default_inflections.includes(value);});
	console.log(all_possible_inflections);
	var from_box =  document.getElementById("lstBox1");
	var to_box = document.getElementById("lstBox2");
	for (i = 0; i < all_possible_inflections.length; i++) {
		var cur_value = all_possible_inflections[i];
		var opt = document.createElement("option");
		opt.value= cur_value;
		opt.innerHTML = cur_value;

		if (default_inflections.includes(cur_value)){		
			to_box.appendChild(opt);
		}
		else {
			from_box.appendChild(opt);
		}		
	}
  }
  
  function get_all_possible_inflections(){
	return Object.keys(all_verbs["amo"]);
  }
  
  function populate_verbs_in_select(){
	verbs_keys = Object.keys(all_verbs)
	var verb_select = document.getElementById("verbs_datalist");
	var verb_select_parent = document.getElementById("verb_select");
	for (i = 0, k_len=verbs_keys.length; i < k_len; i++) {
		var opt = document.createElement("option");
		opt.value= verbs_keys[i];
		opt.innerHTML = verbs_keys[i];	   
		verb_select.appendChild(opt);
	}
	
	verb_select_parent.addEventListener("keydown", function(event) {	
	var x = event.which || event.keyCode;
	if (x === 13) {		
		add_verb_from_select();
	}
	});
  }
  
  function add_verb_from_select(){
	var verb_select = document.getElementById("verb_select");
	var current_selected_verb = verb_select.value;
	if (current_selected_verb != ""){
		add_verbs_to_box([current_selected_verb]);
		verb_select.value = "";
	}
  }
  
  function get_filtered_verbs_by_freq(){
	ratio = parseFloat(document.getElementById("level_select").value);
	number_of_verbs_in_pool = parseInt(ratio * sorted_verbs.length);
	console.log(number_of_verbs_in_pool);
	return sorted_verbs.slice(0, number_of_verbs_in_pool);
  }
  
  function generate_random_verbs(){
	verbs_pool = get_filtered_verbs_by_freq();
	generated_verbs = get_random_from_list(verbs_pool, 10);
	add_verbs_to_box(generated_verbs);
	document.getElementById("verbs_box").value = generated_verbs;	
	load_possible_mutations();
  }
  
  function get_is_on_exam(){
	is_exam = document.getElementById("is_exam_cb").checked;	
  }
  
  function init_exam(){
	var selected_inflections = get_selected_inflection_from_box();
	if (!selected_inflections.length){
		alert("please select inflection(s)");
		return;
	}
	if (!selected_verbs.length){
		alert("please select verb(s)");
		return;
	}	
	mutation_dict = get_valid_mutations_dict();
	if (is_obj_empty(mutation_dict)){
		alert("We have no valid inflection for those verbs. change something!");
		return;
	}
	
	set_mutations_left();
	mistake_counter = 0;
	correct_counter = 0;
	set_answer_counter();
	document.getElementById("res").innerHTML = "";
	start_q();
  }  
  
  function start_q(){
	document.getElementById("user_answer").value = "";	
	console.log(mutation_dict);
	current_mutation = select_mutation()
    document.getElementById("question").innerHTML = current_mutation;	
  }
  
  function is_exam_completed(){
	return is_obj_empty(mutation_dict);
  }
  
  function conclude_q(){			
	if (is_user_correct()){
		color = "green";
		mutation_dict[current_mutation] /= 2;
		correct_counter += 1;
	}
	else{
		color = "red";
		mutation_dict[current_mutation] = 1;
		mistake_counter += 1;
	}	
	
	document.getElementById("res").style.color = color;
	document.getElementById("res").innerHTML = get_correct_answer_for_current_mutation();
	set_answer_counter();
	
	if (is_exam){
		delete mutation_dict[current_mutation];
		set_mutations_left();
	}
	if (!is_exam_completed()){	
		start_q();
	}
	else{
		end_exam();
	}
  }
  
  function set_answer_counter(){
	document.getElementById("answer_counter").innerHTML = correct_counter + "\\" + (correct_counter+mistake_counter);
  }
  
  function set_final_score(){
	var final_score = parseInt(100* parseFloat(correct_counter) / parseFloat(mistake_counter+correct_counter));
	document.getElementById("answer_counter").innerHTML = "Final score: " + final_score + "% [" + correct_counter + "/" + (correct_counter+mistake_counter) + "]";
  }
  

  function add_verbs_to_box(new_verbs_to_add){
	verbs_box = document.getElementById("verbs_box")
	verbs_string = verbs_box.value;
	current_verbs = verbs_string.split(",");
	if (current_verbs[0] == ""){
		current_verbs.shift();
	}
	current_verbs.push(new_verbs_to_add);
	verbs_box.value = current_verbs;
  }
  
  function load_possible_mutations(){
	get_verbs_from_input();
	get_valid_mutations_dict();
  }
  
  function get_verbs_from_input(){
	selected_verbs = [];
	verbs_string = document.getElementById("verbs_box").value;
	_verbs = verbs_string.split(",");
	console.log(_verbs);
	bad_verbs = []
	for (i = 0; i < _verbs.length; i++) {
		current_verb = _verbs[i].trim();
		if (current_verb == ""){
			continue;}
		if (current_verb in all_verbs){
			if (!(selected_verbs.includes(current_verb))) {
				selected_verbs.push(current_verb);
			}
		}
		else{
			bad_verbs.push(current_verb);
		}
	}
	
	document.getElementById("verbs_box").value = selected_verbs;
	
	if (bad_verbs.length){	
		document.getElementById("verbs_error_p").innerHTML = "those verbs are not in list, they might have more than one possible conjugation. Try search it manually from the list to add the conjugation";
	}
	else{
		document.getElementById("verbs_error_p").innerHTML = "";
	}
	document.getElementById("verbs_error_box").innerHTML =  bad_verbs;
	
  }
  
  function remove_mutation(){
	delete mutation_dict[current_mutation];
	if (is_obj_empty(mutation_dict)){
		document.getElementById("res").style.color = "green";
		document.getElementById("res").innerHTML = "Mirabile! Tu scis omnia. Elige alia verba/infleciones";
		end_exam();
	}
	else{
		document.getElementById("res").style.color = "gray";
		document.getElementById("res").innerHTML = "Bene, iam scis hoc...sed allia?";
		set_mutations_left();
		start_q();
	}
  }
  
  function set_mutations_left(){
	ml = Object.keys(mutation_dict).length
	document.getElementById("mutations_left").innerHTML = "mutations left: " + ml;
  }
  
  function end_exam(){
	document.getElementById("mutations_left").innerHTML = "";
	//document.getElementById("answer_counter").innerHTML = "";
	if (is_exam){
		set_final_score();
	}
  }
  
  function is_user_correct(){	
	user_answer = document.getElementById("user_answer").value;
	correct_answer = get_correct_answer_for_current_mutation();
	return (user_answer == correct_answer);
  }
  
  function get_correct_answer_for_current_mutation(){
	console.log(current_mutation);
	dict_res = all_verbs[current_mutation[0]][current_mutation[1]];
	if (dict_res){
		return dict_res.split(",")[0].trim();
	}
    return dict_res;
  }

  
  </script>
  
  <script>
  function select_mutation(){
	 return select_weighted_random(mutation_dict).split(",");
  }
  
  function is_mutation_valid(verb, inflection){
	dict_value = all_verbs[verb][inflection];
	return (dict_value != null) && (dict_value != "--");
  }
  
  function get_selected_inflection_from_box(){
	var selected_inflections = [];
	var to_box_options = document.getElementById("lstBox2").options;
	for (i = 0; i < to_box_options.length; i++){
		selected_inflections.push(to_box_options[i].value);
	}
	
	return selected_inflections;
  }
  
  function get_valid_mutations_dict(){
	var mutation_dict = {};
	var bad_mutations = [];
	var bad_mutation_text = "";
	var selected_inflections = get_selected_inflection_from_box();
	for (i = 0, v_len = selected_verbs.length; i < v_len; i++) {
		for (j = 0, i_len = selected_inflections.length; j < i_len; j++) {
			if (is_mutation_valid(selected_verbs[i], selected_inflections[j])){				
				mutation_dict[[selected_verbs[i], selected_inflections[j]]] = 1;
			}
			else{
				bad_mutations.push([selected_verbs[i], selected_inflections[j]])				
			}
		}
	}	
	for (i = 0, b_len = bad_mutations.length; i < b_len; i++) {
		console.log("bad mutation: " + bad_mutations[i]);
		bad_mutation_text += "*verb \"" + bad_mutations[i][0] + "\" does not have \"" + bad_mutations[i][1] + "\" inflection\n";
	}
	
	document.getElementById("inflections_error_box").innerHTML = bad_mutation_text;
	return mutation_dict;
  }
  
  function select_weighted_random(prob){  
	var i=0;
	var sum=0;
	var w_sum = 0;
	for (x in prob){
		w_sum += prob[x];
	}
	var r=Math.random() * w_sum;
	for (i in prob) {
		sum += prob[i];
		if (r <= sum) return i;
	 }
  }
  
  function is_obj_empty(_obj){
	for (i in _obj){
		return false;}
	return true;
  }
      
  function get_random_from_list(l, count){	
	var selected = [];
	while (selected.length < count){
		current_selected = l[Math.floor(Math.random() * l.length)];
		if (!selected.includes(current_selected)){
			selected.push(current_selected);
		}
	}
	
    return selected;
  }
  
  </script>
    
  <script>
  // for wait
  //alert("I am an alert box!");
//  verbs = verbs.responseJSON;
//  console.log(verbs["a"])
 // http://www.perseus.tufts.edu/hopper/morph?l=anno&la=la&can=anno0#lexicon
 // http://www.perseus.tufts.edu/hopper/loadquery?doc=Perseus:text:1999.04.0059:entry=anno2
  </script>

</body>

</html>
